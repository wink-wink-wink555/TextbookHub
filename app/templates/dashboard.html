<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>仪表盘 - 高校教材管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="dashboard">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-book-open"></i>
                </div>
                <h2>教材管理系统</h2>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-details">
                    <div class="user-name" id="userName">加载中...</div>
                    <div class="user-role" id="userRole">-</div>
                </div>
            </div>
            <ul class="nav-menu">
                <li><a href="/dashboard" class="active"><i class="fas fa-home"></i> 仪表盘</a></li>
                <li><a href="/textbooks"><i class="fas fa-book"></i> 教材管理</a></li>
                <li><a href="/publishers"><i class="fas fa-building"></i> 出版社管理</a></li>
                <li><a href="/orders"><i class="fas fa-clipboard-list"></i> 订单管理</a></li>
                <li><a href="/statistics"><i class="fas fa-chart-bar"></i> 统计报表</a></li>
                <li><a href="#" onclick="logout()" class="logout-link"><i class="fas fa-sign-out-alt"></i> 退出登录</a></li>
            </ul>
        </aside>

        <!-- 主内容区 -->
        <main class="main-content">
            <div class="page-header">
                <h1><i class="fas fa-tachometer-alt" style="margin-right: 12px; color: var(--primary-color);"></i>仪表盘</h1>
                <div class="current-time" id="currentTime"></div>
            </div>

            <!-- 统计卡片 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon blue">
                        <i class="fas fa-books"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="textbookCount">-</h3>
                        <p>教材总数</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">
                        <i class="fas fa-yen-sign"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="inventoryValue">-</h3>
                        <p>库存总价值</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon orange">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="pendingOrders">-</h3>
                        <p>待处理订单</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon red">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="warningCount">-</h3>
                        <p>库存预警</p>
                    </div>
                </div>
            </div>

            <!-- 按类型统计 -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-chart-pie"></i> 各类教材统计</h3>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table id="typeStatsTable">
                            <thead>
                                <tr>
                                    <th>类型名称</th>
                                    <th>类型编码</th>
                                    <th>教材种类</th>
                                    <th>订购总量</th>
                                    <th>到货总量</th>
                                    <th>发放总量</th>
                                    <th>当前库存</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="7" class="text-center">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 库存预警 -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-bell"></i> 库存预警</h3>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table id="warningsTable">
                            <thead>
                                <tr>
                                    <th>ISBN</th>
                                    <th>教材名称</th>
                                    <th>出版社</th>
                                    <th>类型</th>
                                    <th>当前库存</th>
                                    <th>预警值</th>
                                    <th>状态</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="7" class="text-center">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/utils.js"></script>
    <script>
        // 检查登录状态
        if (!checkLogin()) {
            window.location.href = '/';
        }

        // 加载用户信息
        const user = getUserInfo();
        if (user) {
            document.getElementById('userName').textContent = user.real_name || user.username;
            document.getElementById('userRole').textContent = user.role;
            document.getElementById('userAvatar').textContent = (user.real_name || user.username).charAt(0);
        }

        // 更新当前时间
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString('zh-CN');
        }
        updateTime();
        setInterval(updateTime, 1000);

        // 加载仪表盘数据
        async function loadDashboard() {
            try {
                const result = await api.getDashboard();
                if (result.code === 200) {
                    const data = result.data;
                    document.getElementById('textbookCount').textContent = data.textbook_count;
                    document.getElementById('inventoryValue').textContent = formatMoney(data.inventory_value);
                    document.getElementById('pendingOrders').textContent = data.pending_orders;
                    document.getElementById('warningCount').textContent = data.warning_count;
                }
            } catch (error) {
                handleError(error, '加载仪表盘数据失败');
            }
        }

        // 加载类型统计（所有登录用户都可以查看）
        async function loadTypeStats() {
            try {
                const result = await api.getStatisticsByType();
                if (result.code === 200) {
                    const tbody = document.querySelector('#typeStatsTable tbody');
                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center">暂无数据</td></tr>';
                        return;
                    }
                    tbody.innerHTML = result.data.map(item => `
                        <tr>
                            <td>${item.type_name}</td>
                            <td>${item.type_code}</td>
                            <td>${item.textbook_count}</td>
                            <td>${item.order_quantity}</td>
                            <td>${item.arrived_quantity}</td>
                            <td>${item.issued_quantity}</td>
                            <td><strong>${item.current_quantity}</strong></td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                // 如果是403权限错误，显示友好提示
                if (error.message && error.message.includes('403')) {
                    const tbody = document.querySelector('#typeStatsTable tbody');
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">您没有权限查看此数据</td></tr>';
                } else {
                    handleError(error, '加载类型统计失败');
                }
            }
        }

        // 加载库存预警（仅管理员和仓库管理员可见）
        async function loadWarnings() {
            // 检查权限
            if (!isAdminOrWarehouse()) {
                const tbody = document.querySelector('#warningsTable tbody');
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">您没有权限查看库存预警数据</td></tr>';
                return;
            }
            
            try {
                const result = await api.getInventoryWarnings();
                if (result.code === 200) {
                    const tbody = document.querySelector('#warningsTable tbody');
                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center">暂无预警</td></tr>';
                        return;
                    }
                    tbody.innerHTML = result.data.map(item => `
                        <tr>
                            <td>${item.isbn}</td>
                            <td>${item.textbook_name}</td>
                            <td>${item.publisher_name}</td>
                            <td>${item.type_name}</td>
                            <td><strong>${item.current_quantity}</strong></td>
                            <td>${item.min_quantity} - ${item.max_quantity}</td>
                            <td>${createStatusBadge(item.status)}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                // 如果是403错误，显示权限不足提示
                if (error.message && error.message.includes('403')) {
                    const tbody = document.querySelector('#warningsTable tbody');
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">您没有权限查看库存预警数据</td></tr>';
                } else {
                    handleError(error, '加载库存预警失败');
                }
            }
        }

        // 初始化加载
        loadDashboard();
        loadTypeStats();
        loadWarnings();
        
        // 根据权限隐藏库存预警卡片
        window.addEventListener('load', function() {
            if (!isAdminOrWarehouse()) {
                // 将库存预警卡片设置为半透明
                const warningCard = document.getElementById('warningCount');
                if (warningCard) {
                    warningCard.textContent = '-';
                    warningCard.parentElement.parentElement.style.opacity = '0.5';
                    warningCard.parentElement.parentElement.title = '只有管理员和仓库管理员可以查看';
                }
            }
        });
    </script>
</body>
</html>
